<%- include('../../views/partials/user/header') %>

<!-- offer section -->
<section class="offer_section layout_padding-bottom">
  <div class="offer_container">
    <div class="container">
      <div class="row">
        <% if (offers && offers.length > 0) { %> <%
        offers.forEach(function(offer) { %>
        <div class="col-md-6 mb-4">
          <div class="box">
            <div class="img-box">
              <img
                src="<%= offer.image || 'images/o1.jpg' %>"
                alt="<%= offer.title %>"
              />
            </div>
            <div class="detail-box">
              <h5><%= offer.title %></h5>
              <h6><span><%= offer.discountPercentage %>%</span> Off</h6>
              <p class="text-muted"><%= offer.description %></p>
            </div>
          </div>
        </div>
        <% }); %> <% } %>
      </div>
    </div>
  </div>
</section>
<!-- end offer section -->

<!-- food section -->
<section class="food_section layout_padding-bottom">
  <div class="container">
    <div class="heading_container heading_center">
      <h2>Our Menu</h2>
    </div>

    <ul class="filters_menu">
      <li>
        <a href="/?category=all" style="color: black">All</a>
      </li>
      <% if (categories && categories.length > 0) { %> <%
      categories.forEach(function(category) { %>
      <li>
        <a href="/?category=<%= category._id %>" style="color: black"
          ><%= category.name %></a
        >
      </li>
      <% }); %> <% } %>
    </ul>

    <div class="filters-content">
      <div class="row grid">
        <% if (products && products.length > 0) { %> 
        <% products.forEach(function(product) { 
          if (!product.category || product.category.isBlocked) return;
        %>
        <div
          class="col-sm-6 col-lg-4 all <%= product.category.name.toLowerCase() %>"
        >
          <div class="box">
            <div>
              <div class="img-box">
                <img
                  src="<%= product.productImage[0] %>"
                  alt="<%= product.name %>"
                  class="food-item-image"
                  data-product-id="<%= product._id %>"
                />
              </div>
              <div class="detail-box">
                <h5><%= product.name %></h5>
                <p
                  style="
                    display: -webkit-box;
                    -webkit-line-clamp: 2;
                    line-clamp: 2;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                  "
                >
                  <%= product.description %>
                </p>
                <div class="options">
                  <div class="price-info">
                    <div class="price-wrapper">
                      <span class="regular-price strike"
                        >₹<%= product.regularPrice %></span
                      >
                      <% if (product.offerDetails &&
                      product.offerDetails.finalPrice) { %>
                      <span class="price-separator">|</span>
                      <span class="sale-price"
                        >₹<%= product.offerDetails.finalPrice %></span
                      >
                      <% } else if (product.salesPrice && product.salesPrice <
                      product.regularPrice) { %>
                      <span class="price-separator">|</span>
                      <span class="sale-price">₹<%= product.salesPrice %></span>
                      <% } %>
                    </div>
                  </div>
                  <% if (locals.user) { %>
                     <% if (product.quantity === 0) { %>
    <button
      class="btn btn-sm ms-2 btn-secondary"
      disabled
      title="Out of Stock"
    >
       Out of Stock
    </button>
  <% } else { %>
    <button
      class="btn btn-sm ms-2 btn-cart-toggle <%= product.isInCart ? 'btn-success' : 'btn-outline-success' %>"
      data-product-id="<%= product._id %>"
      <%= product.isInCart ? 'disabled' : '' %>
    >
      <i class="fas <%= product.isInCart ? 'fa-check' : 'fa-shopping-cart' %> me-1"></i>
      <%= product.isInCart ? 'Added' : 'Add' %>
    </button>
  <% } %>
  

                  <button
                    class="wishlist-btn <%= product.isInWishlist ? 'active text-danger' : '' %>"
                    data-product-id="<%= product._id %>"
                    onclick="toggleWishlist('<%= product._id %>', this)"
                    title="<%= product.isInWishlist ? 'Remove from Wishlist' : 'Add to Wishlist' %>"
                  >
                    <i
                      class="fa<%= product.isInWishlist ? 's' : 'r' %> fa-heart"
                    ></i>
                  </button>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>
        <% }); %> <% } %>
      </div>
    </div>
    <div class="btn-box">
      <a href="/menu"> View More </a>
    </div>
  </div>
</section>
<!-- end food section -->

<style>
  .btn-secondary {
  background-color: #ff0202 !important;
  color: #333;
  cursor: not-allowed;
}

  .price-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .price-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .sale-price {
    font-size: 1.1rem;
    font-weight: 700;
    color: #ffbe33;
    letter-spacing: -0.3px;
  }

  .regular-price {
    font-size: 0.85rem;
    color: #636e72;
    opacity: 0.7;
  }

  .regular-price.strike {
    text-decoration: line-through;
    text-decoration-color: #dc3545;
    text-decoration-thickness: 2px;
  }

  .price-separator {
    color: #636e72;
    opacity: 0.7;
  }

  .options {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 10px;
  }

  .wishlist-btn {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    font-size: 1.2em;
    transition: transform 0.2s;
  }

  .wishlist-btn:hover {
    transform: scale(1.1);
  }

  .wishlist-btn.active {
    color: #dc3545;
  }
</style>

<%- include('../../views/partials/user/footer') %>

<script>
  
document.addEventListener("DOMContentLoaded", function () {
    const cartButtons = document.querySelectorAll(".btn-cart-toggle");

    cartButtons.forEach((button) => {
      if (!button.disabled) {
        button.addEventListener("click", async function () {
          const productId = button.getAttribute("data-product-id");
          button.disabled = true;
          button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i> Adding...`;

          try {
            const res = await fetch(`/cart/add/${productId}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });

            const data = await res.json();

            if (data.success) {
              // ✅ Sweet Alert
              Swal.fire({
                icon: 'success',
                title: 'Added to Cart!',
                showConfirmButton: false,
                timer: 1000,
                toast: true,
                position: 'top-end'
              });

              setTimeout(() => {
                location.reload();
              }, 1000); // Refresh after alert
            } else {
              button.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i> Failed`;
              button.disabled = false;
            }
          } catch (err) {
            console.error(err);
            button.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i> Error`;
            button.disabled = false;
          }
        });
      }
    });
  });


  async function toggleWishlist(productId, button) {
    try {
      const response = await fetch(`/wishlist/toggle/${productId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      });

      const data = await response.json();

      if (data.success) {
        // Toggle heart icon
        const heartIcon = button.querySelector("i");
        if (data.action === "added") {
          heartIcon.classList.remove("far");
          heartIcon.classList.add("fas");
          button.classList.add("active", "text-danger");
          button.title = "Remove from Wishlist";

          // Show success toast
          Swal.fire({
            icon: "success",
            title: "Added to Wishlist",
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 500,
          });
        } else {
          heartIcon.classList.remove("fas");
          heartIcon.classList.add("far");
          button.classList.remove("active", "text-danger");
          button.title = "Add to Wishlist";

          // Show removed toast
          Swal.fire({
            icon: "success",
            title: "Removed from Wishlist",
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 500,
          });
        }

        // Update wishlist count if available
        if (data.wishlistCount !== undefined) {
          const wishlistCountElement =
            document.querySelector(".wishlist-count");
          if (wishlistCountElement) {
            wishlistCountElement.textContent = data.wishlistCount;
          }
        }
      } else {
        throw new Error(data.message || "Failed to update wishlist");
      }
    } catch (error) {
      console.error("Error:", error);
      // If unauthorized, redirect to login
      if (error.status === 401) {
        window.location.href = "/login";
        return;
      }

      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: error.message || "Failed to update wishlist. Please try again.",
        toast: true,
        position: "top-end",
        showConfirmButton: false,
        timer: 3000,
      });
    }
  }

  document.querySelectorAll(".food-item-image").forEach((img) => {
    img.addEventListener("click", function () {
      const productId = this.dataset.productId;
      
      <% if (user) { %>
        window.location.href = `/food/${productId}`;
      <% } else { %>
        window.location.href = '/login';
      <% } %>
    });
    img.style.cursor = "pointer";
  });

  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const loginStatus = urlParams.get('login');
    
    if (loginStatus === 'success') {
      const newUrl = window.location.pathname;
      window.history.replaceState({}, document.title, newUrl);
      
      Swal.fire({
        title: 'Login Successful!',
        text: 'Welcome back to Derry World!',
        icon: 'success',
        confirmButtonColor: '#ffbe33',
        timer: 2000,
        timerProgressBar: true,
        showConfirmButton: false
      });
    }
  });
</script>

