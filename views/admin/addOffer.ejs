<%- include('../partials/admin/header') %>

<main class="col-md-10 ms-sm-auto col-lg-10 px-md-4">
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Add New Offer</h5>
                    </div>
                    <div class="card-body">
                        <% if (error) { %>
                            <div class="alert alert-danger" role="alert">
                                <%= error %>
                            </div>
                        <% } %>
                        
                        <form id="offerForm" method="POST" onsubmit="event.preventDefault(); saveOffer(event);">
                            <div class="mb-3">
                                <label for="offerName" class="form-label">Offer Name</label>
                                <input type="text" class="form-control" id="offerName" name="offerName" required>
                            </div>

                            <div class="mb-3">
                                <label for="type" class="form-label">Offer Type</label>
                                <select class="form-select" id="type" name="type" required onchange="handleOfferTypeChange()">
                                    <option value="">Select Type</option>
                                    <option value="product">Product Offer</option>
                                    <option value="category">Category Offer</option>
                                    <option value="referral">Referral Offer</option>
                                </select>
                            </div>

                            <div class="mb-3" id="productField" style="display: none;">
                                <label for="product" class="form-label">Select Product</label>
                                <select class="form-select" id="product" name="product">
                                    <option value="">Select Product</option>
                                    <% products.forEach(product => { %>
                                        <option value="<%= product._id %>"><%= product.name %> - â‚¹<%= product.price %></option>
                                    <% }); %>
                                </select>
                            </div>

                            <div class="mb-3" id="categoryField" style="display: none;">
                                <label for="category" class="form-label">Select Category</label>
                                <select class="form-select" id="category" name="category">
                                    <option value="">Select Category</option>
                                    <% categories.forEach(category => { %>
                                        <option value="<%= category._id %>"><%= category.name %></option>
                                    <% }); %>
                                </select>
                            </div>

                            <div class="mb-3" id="referralField" style="display: none;">
                                <label for="referralType" class="form-label">Referral Type</label>
                                <select class="form-select" id="referralType" name="referralType">
                                    <option value="">Select Type</option>
                                    <option value="referrer">Referrer</option>
                                    <option value="referee">Referee</option>
                                    <option value="both">Both</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="discountType" class="form-label">Discount Type</label>
                                <select class="form-select" id="discountType" name="discountType" required onchange="handleDiscountTypeChange()">
                                    <option value="percentage">Percentage</option>
                                    <option value="fixed">Fixed Amount</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="discountValue" class="form-label">Discount Value</label>
                                <input type="number" class="form-control" id="discountValue" name="discountValue" min="0" required>
                                <small class="text-muted">For percentage, enter value between 0-100. For fixed amount, enter value in rupees.</small>
                            </div>

                            <div class="mb-3" id="maxDiscountField" style="display: none;">
                                <label for="maxDiscount" class="form-label">Maximum Discount Amount</label>
                                <input type="number" class="form-control" id="maxDiscount" name="maxDiscount" min="0">
                                <small class="text-muted">Maximum discount amount in rupees (for percentage discounts)</small>
                            </div>

                            <div class="mb-3">
                                <label for="minPurchase" class="form-label">Minimum Purchase Amount</label>
                                <input type="number" class="form-control" id="minPurchase" name="minPurchase" min="0">
                                <small class="text-muted">Minimum purchase amount in rupees (0 for no minimum)</small>
                            </div>

                            <div class="mb-3">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate" name="startDate" required>
                            </div>

                            <div class="mb-3">
                                <label for="endDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate" name="endDate" required>
                            </div>

                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="usageLimit" class="form-label">Usage Limit</label>
                                <input type="number" class="form-control" id="usageLimit" name="usageLimit" min="0">
                                <small class="text-muted">Maximum number of times this offer can be used (leave empty for unlimited)</small>
                            </div>

                            <div class="text-end">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Offer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Add date validation script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const today = new Date().toISOString().split('T')[0];

    // Set minimum date for start date as today
    startDateInput.min = today;

    startDateInput.addEventListener('change', function() {
        // Set minimum date for end date as start date
        endDateInput.min = startDateInput.value;
        
        // If end date is before new start date, update it
        if (endDateInput.value < startDateInput.value) {
            endDateInput.value = startDateInput.value;
        }
    });

    // Validate discount value based on type
    const discountTypeSelect = document.getElementById('discountType');
    const discountValueInput = document.getElementById('discountValue');

    discountTypeSelect.addEventListener('change', function() {
        if (this.value === 'percentage') {
            discountValueInput.max = '100';
            if (discountValueInput.value > 100) {
                discountValueInput.value = 100;
            }
        } else {
            discountValueInput.removeAttribute('max');
        }
    });

    // Initial validation for discount value
    if (discountTypeSelect.value === 'percentage') {
        discountValueInput.max = '100';
    }
});
</script>

<%- include('../partials/admin/footer') %>