<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="shortcut icon" href="/images/favicon.png" type="" />
    <title>Derry World</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/css/nice-select.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="/css/style.css" rel="stylesheet" />
    <link href="/css/responsive.css" rel="stylesheet" />
    
    <!-- Core JS -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
      .header_section {
        background: #222831;
      }

      .user_option {
        display: flex;
        align-items: center;
        margin-left: auto;
        gap: 20px;
      }

      .cart_link {
        position: relative !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin-left: 15px;
        width: 40px !important;
        height: 40px !important;
        transition: all 0.3s ease !important;
      }

      .cart_link:hover {
        opacity: 0.8 !important;
      }

      .cart_link svg {
        width: 22px !important;
        height: 22px !important;
        fill: #ffffff !important;
      }

      .cart-count {
        position: absolute !important;
        top: -5px !important;
        right: -5px !important;
        background-color: #ffbe33 !important;
        color: #222831 !important;
        border-radius: 50% !important;
        width: 20px !important;
        height: 20px !important;
        font-size: 12px !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      }

      .user-dropdown {
        margin-left: 15px;
      }

      .user-dropdown .dropdown-toggle {
        color: #ffffff;
        text-decoration: none;
        display: flex;
        align-items: center;
        padding: 8px;
        border-radius: 4px;
      }

      .user-dropdown .dropdown-toggle:hover,
      .user-dropdown .dropdown-toggle:focus {
        color: #ffbe33;
        background: rgba(255, 255, 255, 0.1);
      }

      .user-dropdown .dropdown-menu {
        background: #222831;
        border: 1px solid #ffbe33;
        margin-top: 10px;
        min-width: 200px;
        padding: 8px 0;
      }

      .user-dropdown .dropdown-item {
        color: #ffffff;
        padding: 8px 20px;
        transition: all 0.3s ease;
      }

      .user-dropdown .dropdown-item:hover {
        background: #ffbe33;
        color: #222831;
      }

      .navbar-toggler {
        background-color: #ffbe33;
        padding: 8px 12px;
      }

      .navbar-toggler-icon {
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3e%3cpath stroke='rgba(34, 40, 49, 1)' stroke-width='2' stroke-linecap='round' stroke-miterlimit='10' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      }
    </style>
    
  </head>
  <body class="sub_page">
    <div class="hero_area">
      <header class="header_section">
        <div class="container">
          <nav class="navbar navbar-expand-lg custom_nav-container">
            <a class="navbar-brand" href="/">
              <span>Derry World</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
              <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav mx-auto">
                <li class="nav-item <%= locals.path === '/' ? 'active' : '' %>">
                  <a class="nav-link" href="/">Home</a>
                </li>
                <% if (locals.user) { %>
                  <li class="nav-item <%= locals.path === '/menu' ? 'active' : '' %>">
                    <a class="nav-link" href="/menu">Menu</a>
                  </li>
                  <li class="nav-item <%= locals.path === '/about' ? 'active' : '' %>">
                    <a class="nav-link" href="/about">About</a>
                  </li>
                  <li class="nav-item <%= locals.path === '/contact' ? 'active' : '' %>">
                    <a class="nav-link" href="/contact">Contact</a>
                  </li>
                <% } %>
              </ul>

              <div class="user_option">
                <% if (locals.user) { %>
                  <!-- User Dropdown -->
                <div class="user-dropdown dropdown">
                    <a class="dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="fa fa-user me-2"></i>
                      <%= locals.user ? locals.user.name : 'Guest' %>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                      <li><a class="dropdown-item" href="/profile">Profile</a></li>
                      <li><a class="dropdown-item" href="/orders">Orders</a></li>
                      <li><a class="dropdown-item" href="/wishlist">Wishlist</a></li>
                      <li><a class="dropdown-item" href="/addresses">Addresses</a></li>
                      <li><a class="dropdown-item" href="/wallet">Wallet</a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="#" onclick="handleLogout(event)">Logout</a></li>
                    </ul>
                  </div>
                  </div>

                  <!-- Cart Link -->
                  <a href="/cart" class="cart_link">
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 456.029 456.029" xml:space="preserve">
                      <g><g><path d="M345.6,338.862c-29.184,0-53.248,23.552-53.248,53.248c0,29.184,23.552,53.248,53.248,53.248c29.184,0,53.248-23.552,53.248-53.248C398.336,362.926,374.784,338.862,345.6,338.862z" /></g></g>
                      <g><g><path d="M439.296,84.91c-1.024,0-2.56-0.512-4.096-0.512H112.64l-5.12-34.304C104.448,27.566,84.992,10.67,61.952,10.67H20.48C9.216,10.67,0,19.886,0,31.15c0,11.264,9.216,20.48,20.48,20.48h41.472c2.56,0,4.608,2.048,5.12,4.608l31.744,216.064c4.096,27.136,27.648,47.616,55.296,47.616h212.992c26.624,0,49.664-18.944,55.296-45.056l33.28-166.4C457.728,97.71,450.56,86.958,439.296,84.91z" /></g></g>
                      <g><g><path d="M215.04,389.55c-1.024-28.16-24.576-50.688-52.736-50.688c-29.696,1.536-52.224,26.112-51.2,55.296c1.024,28.16,24.064,50.688,52.224,50.688h1.024C193.536,443.31,216.576,418.734,215.04,389.55z" /></g></g>
                    </svg>
                    <% if (locals.cartCount !== undefined) { %>
                      <span class="cart-count"><%= cartCount %></span>
                    <% } %>
                  </a>
                <% } else { %>
                  <a href="/login" class="order_online">Login</a>
                  <a href="/register" class="order_online">Register</a>
                <% } %>
              </div>
            </div>
          </nav>
        </div>
      </header>
    </div>
  </body>

  <script>
    function handleLogout(event) {
      event.preventDefault();
      Swal.fire({
        title: 'Are you sure?',
        text: "You will be logged out of your account",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ffbe33',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, logout',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          // Clear any ongoing AJAX requests
          if (window.activeAjaxRequests) {
            window.activeAjaxRequests.forEach(request => request.abort());
          }
          window.location.href = '/logout';
        }
      });
    }

    // Initialize Bootstrap components
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize all dropdowns
      var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'))
      var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
        return new bootstrap.Dropdown(dropdownToggleEl)
      })
    });

    // Track AJAX requests
    window.activeAjaxRequests = [];
    $(document).ajaxSend(function(event, jqXHR) {
      window.activeAjaxRequests.push(jqXHR);
    });
    $(document).ajaxComplete(function(event, jqXHR) {
      const index = window.activeAjaxRequests.indexOf(jqXHR);
      if (index > -1) {
        window.activeAjaxRequests.splice(index, 1);
      }
    });

    // Handle unauthorized responses globally
    $(document).ajaxError(function(event, jqXHR) {
      if (jqXHR.status === 401) {
        // Clear any ongoing AJAX requests
        window.activeAjaxRequests.forEach(request => request.abort());
        window.activeAjaxRequests = [];
        
        // Redirect to login if not already there
        if (!window.location.pathname.startsWith('/login')) {
          window.location.href = '/login';
        }
      }
    });
  </script>
  
</html>